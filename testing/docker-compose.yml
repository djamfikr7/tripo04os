version: '3.8'

services:
  # Test Database
  postgres-test:
    image: postgres:15
    container_name: postgres-test
    environment:
      POSTGRES_DB: tripo04os_test
      POSTGRES_USER: test_user
      POSTGRES_PASSWORD: test_password
    ports:
      - "5433:5432"
    volumes:
      - ./shared/fixtures/seed-data.sql:/docker-entrypoint-initdb.d
    networks:
      - testing-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test_user"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Test Redis
  redis-test:
    image: redis:7-alpine
    container_name: redis-test
    ports:
      - "6380:6379"
    networks:
      - testing-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Test Kafka
  kafka-test:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka-test
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper-test:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-test:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: true
    ports:
      - "9093:9092"
    depends_on:
      - zookeeper-test
    networks:
      - testing-network
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions"]
      interval: 10s
      timeout: 10s
      retries: 5

  # Test Zookeeper
  zookeeper-test:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper-test
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2182:2181"
    networks:
      - testing-network

  # Identity Service (Test Mode)
  identity-service-test:
    build: ../backend_services/identity_service
    container_name: identity-service-test
    environment:
      - PORT=8000
      - ENVIRONMENT=test
      - DATABASE_URL=postgresql://test_user:test_password@postgres-test:5432/tripo04os_test
      - REDIS_URL=redis://redis-test:6379/1
    ports:
      - "8020:8000"
    depends_on:
      - postgres-test
      - redis-test
    networks:
      - testing-network

  # Order Service (Test Mode)
  order-service-test:
    build: ../backend_services/order_service
    container_name: order-service-test
    environment:
      - PORT=8001
      - ENVIRONMENT=test
      - DATABASE_URL=postgresql://test_user:test_password@postgres-test:5432/tripo04os_test
      - REDIS_URL=redis://redis-test:6379/1
      - KAFKA_BROKERS=kafka-test:9092
    ports:
      - "8021:8001"
    depends_on:
      - postgres-test
      - redis-test
      - kafka-test
    networks:
      - testing-network

  # Trip Service (Test Mode)
  trip-service-test:
    build: ../backend_services/trip_service
    container_name: trip-service-test
    environment:
      - PORT=8003
      - ENVIRONMENT=test
      - DATABASE_URL=postgresql://test_user:test_password@postgres-test:5432/tripo04os_test
    ports:
      - "8023:8003"
    depends_on:
      - postgres-test
    networks:
      - testing-network

  # Matching Service (Test Mode)
  matching-service-test:
    build: ../backend_services/matching_service
    container_name: matching-service-test
    environment:
      - PORT=8005
      - ENVIRONMENT=test
      - DATABASE_URL=postgresql://test_user:test_password@postgres-test:5432/tripo04os_test
    ports:
      - "8025:8005"
    depends_on:
      - postgres-test
    networks:
      - testing-network

  # Pricing Service (Test Mode)
  pricing-service-test:
    build: ../backend_services/pricing_service
    container_name: pricing-service-test
    environment:
      - PORT=8006
      - ENVIRONMENT=test
      - DATABASE_URL=postgresql://test_user:test_password@postgres-test:5432/tripo04os_test
    ports:
      - "8026:8006"
    depends_on:
      - postgres-test
    networks:
      - testing-network

  # Payment Service (Test Mode)
  payment-service-test:
    build: ../backend_services/payment_service
    container_name: payment-service-test
    environment:
      - PORT=8013
      - ENVIRONMENT=test
      - STRIPE_SECRET_KEY=sk_test_mock
      - STRIPE_WEBHOOK_SECRET=whsec_mock
      - DATABASE_URL=postgresql://test_user:test_password@postgres-test:5432/tripo04os_test
    ports:
      - "8033:8013"
    depends_on:
      - postgres-test
    networks:
      - testing-network

  # Maps Service (Test Mode)
  maps-service-test:
    build: ../backend_services/maps_service
    container_name: maps-service-test
    environment:
      - PORT=8014
      - ENVIRONMENT=test
    ports:
      - "8034:8014"
    networks:
      - testing-network

  # Notification Service (Test Mode)
  notification-service-test:
    build: ../backend_services/notification_service
    container_name: notification-service-test
    environment:
      - PORT=8015
      - ENVIRONMENT=test
      - FIREBASE_CREDENTIALS_PATH=/app/firebase-test-credentials.json
    ports:
      - "8035:8015"
    networks:
      - testing-network

  # SMS Service (Test Mode)
  sms-service-test:
    build: ../backend_services/sms_service
    container_name: sms-service-test
    environment:
      - PORT=8016
      - ENVIRONMENT=test
      - SIMULATE_SMS=true
    ports:
      - "8036:8016"
    networks:
      - testing-network

  # Email Service (Test Mode)
  email-service-test:
    build: ../backend_services/email_service
    container_name: email-service-test
    environment:
      - PORT=8017
      - ENVIRONMENT=test
      - SIMULATE_EMAIL=true
    ports:
      - "8037:8017"
    networks:
      - testing-network

  # Test Runner
  test-runner:
    build: .
    dockerfile: Dockerfile.test
    container_name: test-runner
    environment:
      - TEST_ENV=docker
      - TEST_TIMEOUT=30000
    volumes:
      - ./reports:/app/reports
      - ./shared:/app/shared
    depends_on:
      - postgres-test
      - redis-test
      - kafka-test
      - identity-service-test
      - order-service-test
      - trip-service-test
      - matching-service-test
      - pricing-service-test
      - payment-service-test
      - maps-service-test
      - notification-service-test
      - sms-service-test
      - email-service-test
    networks:
      - testing-network

networks:
  testing-network:
    driver: bridge
